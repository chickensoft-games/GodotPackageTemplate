name: 'ğŸ“¦ Publish to Nuget'
on:
  # Make a release whenever the developer wants.
  workflow_dispatch:
    inputs:
      bump:
        type: string
        description: "major, minor, or patch"
        required: true
        default: "patch"
  # Make a release whenever we're told to by another workflow.
  workflow_call:
    secrets:
      NUGET_API_KEY:
        description: "API key for Nuget"
        required: true
      GH_BASIC:
        description: "Personal access token (PAT) for GitHub"
        required: true
    # Input unifies with the workflow dispatch since it's identical.
    inputs:
      bump:
        type: string
        description: "major, minor, or patch"
        required: true
        default: "patch"

jobs:
  publish:
    name: 'ğŸ“¦ Publish to Nuget'
    runs-on: ubuntu-latest
    steps:
      - name: 'ğŸ§¾ Checkout'
        uses: actions/checkout@v3
        with:
          submodules: 'recursive'
          lfs: 'true'
          token: ${{ secrets.GH_BASIC }}
          ref: ${{ github.ref }}
          fetch-depth: 0 # So we can get all tags.

      - uses: actions/setup-dotnet@v3
        name: ğŸ’½ Setup .NET SDK
        with:
          # Use the .NET SDK from global.json in the root of the repository.
          global-json-file: global.json

      - name: ğŸ” Read Current Project Version
        id: current-version
        uses: WyriHaximus/github-action-get-previous-tag@v1
        with:
          fallback: "0.0.0-devbuild"

      - name: ğŸ–¨ Print Current Version
        run: |
          echo "Current Version: ${{ steps.current-version.outputs.tag }}"

      - name: ğŸ§® Compute Next Version
        uses: chickensoft-games/next-godot-csproj-version@v1
        id: next-version
        with:
          project-version: ${{ steps.current-version.outputs.tag }}
          godot-version: global.json
          bump: ${{ inputs.bump }}

      - uses: actions/setup-dotnet@v4
        name: ğŸ’½ Setup .NET SDK
        with:
          # Use the .NET SDK from global.json in the root of the repository.
          global-json-file: global.json

      # Write version to file so .NET will build correct version.
      - name: ğŸ“ Write Version to File
        uses: jacobtomlinson/gha-find-replace@v3
        with:
          find: "0.0.0-devbuild"
          replace: ${{ steps.next-version.outputs.version }}
          regex: false
          include: Chickensoft.GodotPackageTemplate.csproj

      - name: ğŸ› ï¸ Build
        run: dotnet build Chickensoft.GodotPackageTemplate.csproj -c Release

      - name: ğŸ” Get Package Path
        id: package-path
        run: |
          package=$(find . -name "Chickensoft.GodotPackage.*.nupkg")
          echo "package=$package" >> "$GITHUB_OUTPUT"
          echo "ğŸ“¦ Found package: $package"

      - name: âœ¨ Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GH_BASIC }}
        run: |
          version="${{ steps.next-version.outputs.version }}"
          gh release create --title "v$version" --generate-notes "$version" \
            "${{ steps.package-path.outputs.package }}"
      
      - name: ğŸ“¦ Publish
        id: publish_nuget
        run: |                    
          echo "ğŸ“¦ Publishing package: ${{ steps.package-path.outputs.package }}"
          
          # publish the nuget package
          dotnet nuget push "${{ steps.package-path.outputs.package }}" \
            --api-key ${{ secrets.NUGET_API_KEY }}  \
            --source https://api.nuget.org/v3/index.json --skip-duplicate
